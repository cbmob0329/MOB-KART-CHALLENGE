<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, maximum-scale=1, user-scalable=no" />
<title>MOB Side-Scroll Runner (Mobile)</title>
<meta name="theme-color" content="#0b0c10" />
<style>
  :root{
    --bg:#0b0c10; --panel:#10151f; --panel2:#141b29; --fg:#e9eef7; --dim:#9aa3b2; --acc:#13c4ff; --acc2:#ff3e7f; --ok:#25d366; --warn:#ffb020;
    --hud-h:58px;        /* HUDã®åŸºæœ¬é«˜ã• */
    --pad:12px;          /* å†…å´ä½™ç™½ */
    --footer-h:96px;     /* æ“ä½œãƒœã‚¿ãƒ³ã‚¨ãƒªã‚¢ã®é«˜ã• */
    --maxw:420px;        /* PCé–²è¦§æ™‚ã®ã‚¹ãƒãƒ›é¢¨æœ€å¤§å¹… */
  }

  /* iOSã‚¢ãƒ‰ãƒ¬ã‚¹ãƒãƒ¼å¯¾ç­– */
  html,body { height:100%; }
  html { height:-webkit-fill-available; }
  body {
    margin:0; background:linear-gradient(180deg,#0b0c10 0%, #0c111a 60%, #0b0c10 100%);
    color:var(--fg); font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Hiragino Sans", "Yu Gothic", sans-serif;
    overscroll-behavior:none;
    touch-action:manipulation;
  }

  /* ã‚¹ãƒãƒ›ç”»é¢é¢¨ã®ä¸­å¤®ã‚«ãƒ©ãƒ ï¼ˆPCç¢ºèªæ™‚ã‚‚ã‚¹ãƒãƒ›è¦‹ãˆï¼‰ */
  #app {
    position:fixed; inset:0;
    display:grid; place-items:center;
  }
  #phone {
    width:100%;
    max-width:var(--maxw);
    height:100dvh; /* ç«¯æœ«ã®è¡¨ç¤ºé«˜ã«è¿½å¾“ */
    display:grid; grid-template-rows:auto 1fr auto;
    background:transparent;
  }

  /* ä¸Šéƒ¨HUDï¼ˆã‚­ãƒ£ãƒ³ãƒã‚¹å¤–ã€ç”»é¢å›ºå®šï¼‰ */
  header.hud {
    position:sticky; top:0;
    height:calc(var(--hud-h) + env(safe-area-inset-top));
    padding:calc(env(safe-area-inset-top)) var(--pad) var(--pad);
    box-sizing:border-box;
    display:flex; align-items:flex-end; gap:8px; justify-content:space-between;
    background:linear-gradient(180deg, rgba(20,26,38,.9), rgba(16,21,31,.8));
    backdrop-filter: blur(6px);
    z-index:10; border-bottom:1px solid rgba(255,255,255,.06);
  }
  .hud .row { display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
  .pill {
    background:#1b2233; padding:8px 10px; border-radius:999px; font-size:12px; color:#dfe7f5; letter-spacing:.2px; border:1px solid rgba(255,255,255,.05);
  }
  .boost {
    display:flex; align-items:center; gap:8px; min-width:160px;
  }
  .bar {
    position:relative; width:140px; height:10px; border-radius:999px; background:#0f1420; overflow:hidden; border:1px solid rgba(255,255,255,.08);
  }
  .bar > i { position:absolute; inset:0; width:0%; background:linear-gradient(90deg, var(--acc), #7af0ff); }

  /* ä¸­å¤®ãƒ—ãƒ¬ã‚¤é ˜åŸŸï¼ˆã‚­ãƒ£ãƒ³ãƒã‚¹ï¼‰ */
  main.play {
    position:relative;
    padding:8px 0;
  }
  canvas#game {
    display:block; width:100%; height:100%;
    aspect-ratio:9/16; /* 9:16 ã«å›ºå®šï¼ˆã‚¹ãƒãƒ›é¢¨ï¼‰ */
    background:#060a12; border:1px solid rgba(255,255,255,.06); border-radius:12px;
    touch-action:none;
  }

  /* ä¸‹éƒ¨æ“ä½œï¼ˆã‚­ãƒ£ãƒ³ãƒã‚¹å¤–ã€ç”»é¢å›ºå®šï¼‰ */
  footer.ctrl {
    position:sticky; bottom:0;
    height:calc(var(--footer-h) + env(safe-area-inset-bottom));
    padding:12px 12px calc(12px + env(safe-area-inset-bottom));
    background:linear-gradient(180deg, rgba(16,21,31,.8), rgba(10,14,22,.95));
    backdrop-filter: blur(6px);
    border-top:1px solid rgba(255,255,255,.06);
    display:grid; grid-template-columns:1fr auto 1fr; align-items:center; gap:12px;
    z-index:10;
  }
  .btn {
    -webkit-tap-highlight-color: transparent;
    user-select:none; touch-action:manipulation;
    display:flex; align-items:center; justify-content:center; gap:8px;
    background:#1a2132; border:1px solid rgba(255,255,255,.08);
    color:#fff; padding:14px 10px; border-radius:16px; font-weight:700;
    box-shadow:0 4px 16px rgba(0,0,0,.25);
  }
  .btn:active { transform:translateY(1px); }
  .btn.primary { background:#1c2b44; border-color:#2e4f7a; }
  .btn.ok { background:#1d3b2b; border-color:#2a6d4f; }
  .btn.accent { background:#1a2b3e; border-color:#256787; }
  .btn[disabled] { opacity:.5; filter:grayscale(.2); }

  .slotWrap { display:flex; gap:10px; }
  .slot {
    width:56px; height:56px; border-radius:12px; background:#0f1726; border:1px dashed rgba(255,255,255,.25);
    display:grid; place-items:center; font-size:11px; color:#9fb3d9;
    position:relative; overflow:hidden;
  }
  .slot.full { border-style:solid; border-color:#3c6; background:#14231b; color:#d6f6df; }
  .slot .icon { font-size:18px; opacity:.9; }
  .slot .cap { position:absolute; inset:auto 6px 4px; font-size:10px; color:#9fb3d9; }

  /* ã‚¹ã‚¿ãƒ¼ãƒˆç”»é¢ï¼ˆã‚­ãƒ£ãƒ©é¸æŠï¼‰ */
  #overlay {
    position:absolute; inset:0; display:grid; place-items:center; z-index:20;
    pointer-events:auto;
  }
  .card {
    width:min(92%, 360px); background:linear-gradient(180deg,#0e1320,#0b0f1a); border:1px solid rgba(255,255,255,.08);
    border-radius:16px; padding:16px; box-shadow:0 10px 30px rgba(0,0,0,.4);
  }
  .title { font-weight:800; font-size:18px; margin:0 0 10px; letter-spacing:.3px; }
  .sub { color:var(--dim); font-size:13px; margin-bottom:12px; }
  .choices { display:grid; grid-template-columns:1fr 1fr; gap:10px; }
  .choice {
    background:#121a2a; border:1px solid rgba(255,255,255,.08); border-radius:14px; padding:10px;
    display:grid; gap:8px; justify-items:center; cursor:pointer; user-select:none;
  }
  .choice:active { transform:translateY(1px); }
  .choice img { width:72px; height:72px; object-fit:contain; background:#0c111a; border-radius:10px; border:1px solid rgba(255,255,255,.06); }
  .choice small { color:#a9b4c9; }

  /* å°ã•ãªãƒãƒƒã‚¸ */
  .badge { padding:4px 8px; border-radius:999px; font-size:11px; background:#172131; border:1px solid rgba(255,255,255,.08); color:#cfe7ff; }

  /* ç”»é¢ãŒæ¥µç«¯ã«ä½ã„å ´åˆã€ãƒ•ãƒƒã‚¿ãƒ¼é«˜ã•ã‚’å°‘ã—æŠ‘ãˆã‚‹ */
  @media (max-height: 640px) {
    :root{ --footer-h:84px; --hud-h:52px; }
    .slot { width:52px; height:52px; }
  }
</style>
</head>
<body>
  <div id="app">
    <div id="phone">

      <!-- HUDï¼ˆå›ºå®š / ã‚­ãƒ£ãƒ³ãƒã‚¹å¤–ï¼‰ -->
      <header class="hud" aria-label="ã‚²ãƒ¼ãƒ HUD">
        <div class="row" id="statsLeft">
          <span class="pill" id="dist">è·é›¢ 0 m</span>
          <span class="pill" id="speed">é€Ÿåº¦ 0 km/h</span>
          <span class="pill" id="jump">ã‚¸ãƒ£ãƒ³ãƒ— 2</span>
          <span class="pill" id="coin">ã‚³ã‚¤ãƒ³ 0</span>
        </div>
        <div class="row">
          <div class="pill boost">
            <span class="badge">BOOST</span>
            <div class="bar" aria-label="ãƒ–ãƒ¼ã‚¹ãƒˆã‚²ãƒ¼ã‚¸"><i id="boostFill" style="width:0%"></i></div>
          </div>
        </div>
      </header>

      <!-- ãƒ—ãƒ¬ã‚¤é ˜åŸŸï¼ˆã‚­ãƒ£ãƒ³ãƒã‚¹ã®ã¿ï¼‰ -->
      <main class="play">
        <div style="position:relative">
          <canvas id="game" width="360" height="640" aria-label="ã‚²ãƒ¼ãƒ ç”»é¢"></canvas>

          <!-- ã‚¹ã‚¿ãƒ¼ãƒˆã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ï¼ˆã‚­ãƒ£ãƒ©é¸æŠï¼‰ -->
          <div id="overlay">
            <div class="card">
              <p class="title">ã©ã¡ã‚‰ã‹é¸æŠã—ã¦ã‚¹ã‚¿ãƒ¼ãƒˆ</p>
              <p class="sub">ç”»åƒã¯ãƒªãƒã‚¸ãƒˆãƒªç›´ä¸‹ã« <code>VR.png</code> / <code>orange.png</code> ã‚’é…ç½®ã—ã¦ãã ã•ã„ã€‚</p>
              <div class="choices">
                <div class="choice" data-char="VR">
                  <img src="VR.png" alt="VR ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼" onerror="this.style.opacity='.3'; this.alt='VR.png æœªé…ç½®';">
                  <small>VR.png</small>
                </div>
                <div class="choice" data-char="orange">
                  <img src="orange.png" alt="orange ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼" onerror="this.style.opacity='.3'; this.alt='orange.png æœªé…ç½®';">
                  <small>orange.png</small>
                </div>
              </div>
              <p class="sub" style="margin-top:10px;">â€» ç”»åƒãŒæœªé…ç½®ã§ã‚‚è‰²ä»˜ãã®ä»£æ›¿ã‚·ãƒ«ã‚¨ãƒƒãƒˆã§é–‹å§‹ã§ãã¾ã™ã€‚</p>
            </div>
          </div>
        </div>
      </main>

      <!-- æ“ä½œï¼ˆå›ºå®š / ã‚­ãƒ£ãƒ³ãƒã‚¹å¤–ï¼‰ -->
      <footer class="ctrl" aria-label="æ“ä½œãƒ‘ãƒãƒ«">
        <button class="btn primary" id="btnJump" aria-label="ã‚¸ãƒ£ãƒ³ãƒ—">ã‚¸ãƒ£ãƒ³ãƒ—</button>
        <div class="slotWrap" aria-label="ã‚¢ã‚¤ãƒ†ãƒ ã‚¹ãƒ­ãƒƒãƒˆ">
          <div class="slot" id="slot0"><div class="icon">â€”</div><div class="cap">ç©º</div></div>
          <div class="slot" id="slot1"><div class="icon">â€”</div><div class="cap">ç©º</div></div>
        </div>
        <button class="btn accent" id="btnBoost" aria-label="ãƒ–ãƒ¼ã‚¹ãƒˆ">ãƒ–ãƒ¼ã‚¹ãƒˆ</button>
      </footer>

    </div>
  </div>

<script>
(() => {
  // ========= åŸºæœ¬å‚ç…§ =========
  const cvs = document.getElementById('game');
  const ctx = cvs.getContext('2d');
  const overlay = document.getElementById('overlay');
  const choices = overlay.querySelectorAll('.choice');

  // HUDè¦ç´ 
  const elDist = document.getElementById('dist');
  const elSpeed = document.getElementById('speed');
  const elJump  = document.getElementById('jump');
  const elCoin  = document.getElementById('coin');
  const elBoost = document.getElementById('boostFill');

  // æ“ä½œãƒœã‚¿ãƒ³
  const btnJump  = document.getElementById('btnJump');
  const btnBoost = document.getElementById('btnBoost');

  // ã‚¢ã‚¤ãƒ†ãƒ ã‚¹ãƒ­ãƒƒãƒˆ
  const slots = [
    document.getElementById('slot0'),
    document.getElementById('slot1'),
  ];

  // ========= ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆãƒ»ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°ï¼ˆã‚­ãƒ£ãƒ³ãƒã‚¹ï¼‰ =========
  // 9:16 ã‚¢ã‚¹ãƒšã‚¯ãƒˆã‚’ç¶­æŒã—ã¤ã¤ã€CSSã§æ‹¡å¤§ç¸®å°ã™ã‚‹ãŸã‚ã€å†…éƒ¨è§£åƒåº¦ã¯å›ºå®šã§OK
  function fitCanvasToCss() {
    // CSSã§ aspect-ratio ã‚’9/16ã«å›ºå®šã—ã¦ã‚ã‚‹ãŸã‚ã€æç”»ã¯å†…éƒ¨è§£åƒåº¦(360x640)åŸºæº–ã§OK
    // ã“ã“ã§ã¯ä½•ã‚‚ã—ãªã„ãŒã€å°†æ¥ãƒ‡ãƒã‚¤ã‚¹ãƒ”ã‚¯ã‚»ãƒ«æ¯”ã«å¿œã˜ã¦ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°ã—ãŸã„æ™‚ã¯ã“ã“ã‚’æ‹¡å¼µ
  }
  window.addEventListener('resize', fitCanvasToCss, {passive:true});
  fitCanvasToCss();

  // ========= ã‚²ãƒ¼ãƒ çŠ¶æ…‹ =========
  const W = cvs.width, H = cvs.height;
  const GRAV = 1500;         // é‡åŠ› (px/s^2)
  const JUMP_V = 540;        // ã‚¸ãƒ£ãƒ³ãƒ—åˆé€Ÿ (px/s)
  const FLOOR = H - 68;      // åœ°é¢Y
  const BASE_SPEED = 220;    // åŸºæœ¬ç§»å‹•é€Ÿåº¦ (px/s)
  const BOOST_SPEED = 480;   // ãƒ–ãƒ¼ã‚¹ãƒˆæ™‚  (px/s)
  const BOOST_DRAIN = 24;    // ãƒ–ãƒ¼ã‚¹ãƒˆæ¶ˆè²» (ãƒã‚¤ãƒ³ãƒˆ/ç§’)
  const BOOST_FILL  = 10;    // è‡ªç„¶å›å¾© (ãƒã‚¤ãƒ³ãƒˆ/ç§’)
  const BOOST_MAX   = 100;

  // ã€Œpx/sã€ã‚’ã€Œkm/hã€ã«æ›ç®—ã™ã‚‹ä¿‚æ•°ï¼ˆé©å½“ãªã‚¹ã‚±ãƒ¼ãƒ«ï¼‰
  // 1 px â‰’ 0.02 m ã¨ã¿ãªã™ â†’ 1 px/s â‰’ 0.072 km/h
  const PXPS_TO_KMPH = 0.072;

  const player = {
    x: W*0.25, y: FLOOR, vy: 0,
    w: 48, h: 48,
    jumpsLeft: 2,
    onGround: true,
    img: null,
    fallbackColor: '#f63'
  };

  let running = false;
  let started = false;
  let gameTime = 0;
  let distancePx = 0;   // pxç´¯è¨ˆï¼ˆè¡¨ç¤ºã¯mæ›ç®—ï¼‰
  let forwardSpeed = BASE_SPEED;
  let boost = 0;        // 0-100
  let boosting = false;
  let coins = 0;

  const items = [];     // ã‚¹ãƒ†ãƒ¼ã‚¸ä¸Šã®ã‚¢ã‚¤ãƒ†ãƒ 
  const coinsOnField = []; // ã‚¹ãƒ†ãƒ¼ã‚¸ä¸Šã®ã‚³ã‚¤ãƒ³
  const parallax = { x1:0, x2:0, x3:0 };

  // ã‚¢ã‚¤ãƒ†ãƒ ã‚¹ãƒ­ãƒƒãƒˆï¼ˆ2æ ï¼‰
  const itemSlots = [null, null]; // { type:'boost-pack' | 'shield', icon:'âš¡' ãªã© }

  // ========= ç”»åƒãƒ­ãƒ¼ãƒ‰ï¼ˆä»»æ„ã€æœªé…ç½®ã§ã‚‚OKï¼‰ =========
  const imgVR = new Image(); imgVR.src = 'VR.png';
  const imgOrange = new Image(); imgOrange.src = 'orange.png';

  function setPlayerImage(which) {
    if (which === 'VR') {
      player.img = imgVR.complete ? imgVR : imgVR; // onloadå¾…ã¡ä¸è¦ï¼ˆæç”»å´ã§fallbackï¼‰
      player.fallbackColor = '#6cf';
    } else {
      player.img = imgOrange.complete ? imgOrange : imgOrange;
      player.fallbackColor = '#f63';
    }
  }

  // ========= ã‚¹ã‚¿ãƒ¼ãƒˆï¼ˆã‚­ãƒ£ãƒ©é¸æŠï¼‰ =========
  choices.forEach(c => {
    c.addEventListener('click', () => {
      setPlayerImage(c.dataset.char);
      overlay.style.display = 'none';
      startGame();
    }, {passive:true});
  });

  // ========= æ“ä½œ =========
  function doJump() {
    if (!running) return;
    if (player.jumpsLeft > 0) {
      player.vy = -JUMP_V;
      player.onGround = false;
      player.jumpsLeft--;
      updateHUD();
    }
  }
  function toggleBoost(on) {
    boosting = !!on && boost > 0;
  }

  btnJump.addEventListener('pointerdown', (e)=>{ e.preventDefault(); doJump(); });
  btnBoost.addEventListener('pointerdown', (e)=>{ e.preventDefault(); toggleBoost(true); });
  btnBoost.addEventListener('pointerup',   (e)=>{ e.preventDefault(); toggleBoost(false); });
  btnBoost.addEventListener('pointercancel',(e)=>{ e.preventDefault(); toggleBoost(false); });

  // ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—ç¢ºèªç”¨ï¼ˆã‚¹ãƒãƒ›ã¯ä¸è¦ï¼‰
  window.addEventListener('keydown', (e)=>{
    if (e.code === 'Space' || e.code === 'ArrowUp') doJump();
    if (e.code === 'ShiftLeft' || e.code === 'KeyB') toggleBoost(true);
  });
  window.addEventListener('keyup', (e)=>{
    if (e.code === 'ShiftLeft' || e.code === 'KeyB') toggleBoost(false);
  });

  // ========= è¡çªåˆ¤å®š =========
  function aabb(a,b) {
    return (a.x < b.x + b.w && a.x + a.w > b.x && a.y < b.y + b.h && a.y + a.h > b.y);
  }

  // ========= ã‚¹ãƒãƒ¼ãƒ³ =========
  function spawnCoin() {
    // ç”»é¢å³å´ã«ãƒ©ãƒ³ãƒ€ãƒ é…ç½®ï¼ˆç°¡æ˜“ï¼‰
    const y = FLOOR - 20 - Math.random()*120;
    coinsOnField.push({ x: W + 20, y, w:14, h:14, v: 1 + (Math.random()<0.3?1:0) });
  }
  function spawnItem() {
    // ã‚¢ã‚¤ãƒ†ãƒ ã¯2ç¨®é¡ã®ã©ã¡ã‚‰ã‹
    const kinds = [
      { type:'boost-pack', icon:'âš¡', color:'#6cf', desc:'ãƒ–ãƒ¼ã‚¹ãƒˆå›å¾©' },
      { type:'shield',     icon:'ğŸ›¡ï¸', color:'#9f6', desc:'ï¼ˆå°†æ¥ç”¨ï¼‰' }
    ];
    const kind = kinds[Math.floor(Math.random()*kinds.length)];
    const y = FLOOR - 24 - Math.random()*120;
    items.push({ x: W + 40, y, w:20, h:20, kind });
  }

  // ========= ã‚¢ã‚¤ãƒ†ãƒ å–å¾—å‡¦ç† =========
  function pickupItem(kind) {
    // ç©ºãã‚¹ãƒ­ãƒƒãƒˆæ¤œç´¢
    const idx = itemSlots.findIndex(s => s === null);
    if (idx === -1) {
      flashSlotsFull();
      return false;
    }
    itemSlots[idx] = kind;
    renderSlots();
    return true;
  }
  function flashSlotsFull() {
    slots.forEach((s,i)=>{
      s.animate([{filter:'brightness(1)'},{filter:'brightness(2)'},{filter:'brightness(1)'}], {duration:420});
    });
  }
  function renderSlots() {
    itemSlots.forEach((it,i)=>{
      const s = slots[i];
      s.innerHTML = '';
      if (it) {
        s.classList.add('full');
        const icon = document.createElement('div'); icon.className='icon'; icon.textContent = it.icon;
        const cap  = document.createElement('div'); cap.className='cap';  cap.textContent  = it.type === 'boost-pack' ? 'å……å¡«' : 'ä¿ç®¡';
        s.append(icon, cap);
        s.onclick = () => useItem(i);
      } else {
        s.classList.remove('full');
        const icon = document.createElement('div'); icon.className='icon'; icon.textContent = 'â€”';
        const cap  = document.createElement('div'); cap.className='cap';  cap.textContent  = 'ç©º';
        s.append(icon, cap);
        s.onclick = null;
      }
    });
  }
  function useItem(i) {
    const it = itemSlots[i];
    if (!it) return;
    if (it.type === 'boost-pack') {
      boost = Math.min(BOOST_MAX, boost + 40);
    }
    // ä½¿ã£ãŸã‚‰æ¶ˆè²»
    itemSlots[i] = null;
    renderSlots();
    updateHUD();
  }

  // ========= HUDæ›´æ–° =========
  function updateHUD() {
    const distM = Math.floor(distancePx * 0.02); // pxâ†’mæ›ç®—ï¼ˆ1px=0.02mï¼‰
    elDist.textContent = `è·é›¢ ${distM} m`;

    const kmh = Math.round(forwardSpeed * PXPS_TO_KMPH);
    elSpeed.textContent = `é€Ÿåº¦ ${kmh} km/h`;

    elJump.textContent = `ã‚¸ãƒ£ãƒ³ãƒ— ${player.jumpsLeft}`;
    elCoin.textContent = `ã‚³ã‚¤ãƒ³ ${coins}`;

    const pct = Math.max(0, Math.min(100, boost));
    elBoost.style.width = pct + '%';

    btnBoost.disabled = (pct<=0);
  }

  // ========= ãƒ«ãƒ¼ãƒ— =========
  let prev = 0;
  function loop(t) {
    if (!running) return;
    const now = t || performance.now();
    const dt = Math.min(0.033, (now - prev) / 1000); // å®‰å®šåŒ–
    prev = now;

    gameTime += dt;

    // ã‚¹ãƒ”ãƒ¼ãƒ‰
    if (boosting && boost > 0) {
      forwardSpeed = BOOST_SPEED;
      boost -= BOOST_DRAIN * dt;
      if (boost <= 0) { boost = 0; boosting = false; }
    } else {
      forwardSpeed = BASE_SPEED;
      boost = Math.min(BOOST_MAX, boost + BOOST_FILL * dt);
    }

    // ãƒ‘ãƒ©ãƒ©ãƒƒã‚¯ã‚¹èƒŒæ™¯
    parallax.x1 -= forwardSpeed * 0.25 * dt;
    parallax.x2 -= forwardSpeed * 0.50 * dt;
    parallax.x3 -= forwardSpeed * 1.00 * dt;
    [ 'x1','x2','x3' ].forEach(k => { if (parallax[k] <= -W) parallax[k] += W; });

    // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ç‰©ç†
    player.vy += GRAV * dt;
    player.y  += player.vy * dt;
    if (player.y > FLOOR) {
      player.y = FLOOR;
      player.vy = 0;
      if (!player.onGround) {
        player.onGround = true;
        player.jumpsLeft = 2; // ç€åœ°ã§ãƒªã‚»ãƒƒãƒˆ
      }
    }

    // ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰æ›´æ–°ï¼ˆå³â†’å·¦ã¸æµã‚Œã‚‹ï¼‰
    const flow = forwardSpeed * dt;
    coinsOnField.forEach(c => c.x -= flow);
    while (coinsOnField.length && coinsOnField[0].x < -30) coinsOnField.shift();

    items.forEach(it => it.x -= flow);
    while (items.length && items[0].x < -30) items.shift();

    // ã‚¹ãƒãƒ¼ãƒ³ï¼ˆç°¡æ˜“ãƒ©ãƒ³ãƒ€ãƒ ï¼‰
    if (Math.random() < 0.02) spawnCoin();
    if (Math.random() < 0.006) spawnItem();

    // å–å¾—åˆ¤å®š
    // ã‚³ã‚¤ãƒ³
    for (let i=coinsOnField.length-1; i>=0; i--) {
      const c = coinsOnField[i];
      if (aabb(player, c)) {
        coins += c.v; // 1 or 2
        // ã‚³ã‚¤ãƒ³å–å¾—ã§å¾®é‡ãƒ–ãƒ¼ã‚¹ãƒˆå›å¾©
        boost = Math.min(BOOST_MAX, boost + 4 * c.v);
        coinsOnField.splice(i,1);
      }
    }
    // ã‚¢ã‚¤ãƒ†ãƒ 
    for (let i=items.length-1; i>=0; i--) {
      const it = items[i];
      if (aabb(player, it)) {
        if (pickupItem(it.kind)) {
          items.splice(i,1);
        } else {
          // æº€æ¯æ™‚ã¯æ‹¾ãˆãªã„â†’ãã®ã¾ã¾æµã™
        }
      }
    }

    // è·é›¢åŠ ç®—
    distancePx += flow;

    // æç”»
    draw();

    // HUDæ›´æ–°
    updateHUD();

    requestAnimationFrame(loop);
  }

  // ========= æç”» =========
  function draw() {
    ctx.clearRect(0,0,W,H);

    // èƒŒæ™¯ãƒ¬ã‚¤ãƒ¤ï¼ˆç°¡æ˜“ã‚°ãƒ©ãƒ‡ï¼‹ãƒ‘ãƒ©ãƒ©ãƒƒã‚¯ã‚¹çŸ©å½¢ï¼‰
    // sky
    const g = ctx.createLinearGradient(0,0,0,H);
    g.addColorStop(0,'#08101c');
    g.addColorStop(1,'#0a1322');
    ctx.fillStyle = g; ctx.fillRect(0,0,W,H);

    // é æ™¯ãƒ“ãƒ«
    ctx.fillStyle = '#0d1a2a';
    for (let i=0;i<2;i++){
      const ox = (i===0?parallax.x1:parallax.x2);
      const step = 60*(i===0?1.2:1);
      for (let x=ox; x< W+step; x+=step) {
        const h = 60 + (i===0?40:80) * (0.3 + Math.random()*0.7);
        ctx.fillRect(x, H-160-h, 40, h);
      }
    }

    // åœ°é¢
    ctx.fillStyle = '#122238';
    ctx.fillRect(0, FLOOR+16, W, H-(FLOOR+16));
    // è·¯é¢ãƒ©ã‚¤ãƒ³
    ctx.strokeStyle = 'rgba(255,255,255,.06)';
    ctx.beginPath();
    ctx.moveTo(0, FLOOR+0.5); ctx.lineTo(W, FLOOR+0.5); ctx.stroke();

    // ã‚³ã‚¤ãƒ³
    coinsOnField.forEach(c=>{
      ctx.beginPath();
      ctx.arc(c.x + c.w/2, c.y + c.h/2, c.w/2, 0, Math.PI*2);
      ctx.fillStyle = '#ffd84d';
      ctx.fill();
      // è¼ªéƒ­
      ctx.strokeStyle = '#e7b400';
      ctx.lineWidth = 1;
      ctx.stroke();
      // è¼ã
      ctx.fillStyle = 'rgba(255,255,255,.8)';
      ctx.beginPath(); ctx.arc(c.x + 4, c.y + 4, 3, 0, Math.PI*2); ctx.fill();
    });

    // ã‚¢ã‚¤ãƒ†ãƒ 
    items.forEach(it=>{
      ctx.fillStyle = it.kind.color;
      ctx.fillRect(it.x, it.y, it.w, it.h);
      ctx.fillStyle = '#021019';
      ctx.font = 'bold 12px system-ui';
      ctx.textAlign='center'; ctx.textBaseline='middle';
      ctx.fillText(it.kind.icon, it.x + it.w/2, it.y + it.h/2 + 1);
    });

    // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼
    if (player.img && player.img.complete && player.img.naturalWidth>0) {
      // ç”»åƒãŒæ­£æ–¹å½¢ã§ãªã„å¯èƒ½æ€§ã‚’è€ƒæ…®ã—ã¦å†…æ¥çŸ©å½¢ã§æç”»
      const sz = Math.min(player.w, player.h);
      ctx.drawImage(player.img, player.x, player.y - player.h, sz, sz);
    } else {
      // ä»£æ›¿æç”»ï¼ˆã‚·ãƒ«ã‚¨ãƒƒãƒˆï¼‰
      ctx.fillStyle = player.fallbackColor;
      ctx.fillRect(player.x, player.y - player.h, player.w, player.h);
      ctx.fillStyle = '#00000030';
      ctx.fillRect(player.x+6, player.y - player.h+6, player.w-12, player.h-12);
    }

    // å½±
    ctx.fillStyle = 'rgba(0,0,0,.25)';
    ctx.beginPath();
    ctx.ellipse(player.x + player.w/2, FLOOR+12, player.w*0.45, 6, 0, 0, Math.PI*2);
    ctx.fill();
  }

  // ========= ã‚²ãƒ¼ãƒ é–‹å§‹ =========
  function startGame() {
    if (started) return;
    started = true;
    running = true;
    boost = 60; // åˆæœŸã‚²ãƒ¼ã‚¸
    renderSlots();
    updateHUD();
    prev = performance.now();
    requestAnimationFrame(loop);
  }

  // ========= ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«/ãƒ€ãƒ–ãƒ«ã‚¿ãƒƒãƒ—é˜²æ­¢ =========
  ['touchstart','touchmove','gesturestart'].forEach(ev=>{
    document.addEventListener(ev, (e)=>{
      if (e.target.closest('button, .choice')) return; // UIæ“ä½œã¯è¨±å¯
      e.preventDefault();
    }, {passive:false});
  });

})();
</script>
</body>
</html>
