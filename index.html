<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, maximum-scale=1, user-scalable=no">
<title>MOB æ¨ªã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒ©ãƒ³ãƒŠãƒ¼ï¼ˆå®Œæˆç‰ˆ / 1ãƒ•ã‚¡ã‚¤ãƒ«ï¼‰</title>
<style>
  /* ====== ãƒªã‚»ãƒƒãƒˆ & ç”»é¢åŸºæœ¬ ====== */
  html,body{margin:0;height:100%;background:#000;color:#fff;-webkit-text-size-adjust:100%}
  body{font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue","Hiragino Sans","Yu Gothic",sans-serif;overflow:hidden}
  :root{
    --hud-bg:rgba(13,13,15,.72);
    --hud-fg:#fff;
    --hud-dim:#9aa3ad;
    --accent:#15c3ff;
    --danger:#ff3b30;
    --ok:#4cd964;
    --btn:#1c212b;
    --btn2:#2b303b;
    --shadow:0 8px 28px rgba(0,0,0,.35);
    --gap:10px;
    --r:12px;
  }

  /* ====== ãƒ¬ã‚¤ãƒ¤ãƒ¼ ====== */
  #wrap{position:fixed;inset:0;display:grid;grid-template-rows:1fr;grid-template-columns:1fr}
  #game{position:absolute;inset:0;touch-action:none}
  canvas#cv{position:absolute;inset:0;width:100%;height:100%;display:block;background:#000}

  /* ====== HUDï¼ˆä¸Šéƒ¨å›ºå®šï¼‰ ====== */
  .hud{
    position:fixed;left:calc(env(safe-area-inset-left) + 8px);right:calc(env(safe-area-inset-right) + 8px);
    top:calc(env(safe-area-inset-top) + 8px);
    display:flex;gap:10px;align-items:center;justify-content:space-between;
    padding:8px 10px;border-radius:12px;background:var(--hud-bg);backdrop-filter:saturate(1.2) blur(6px);
    box-shadow:var(--shadow);z-index:10;pointer-events:none;
  }
  .hud .grp{display:flex;gap:10px;align-items:center}
  .pill{
    pointer-events:none;
    display:flex;gap:8px;align-items:center;
    padding:6px 10px;border-radius:999px;background:#101419;border:1px solid rgba(255,255,255,.08);
    font-weight:600;font-variant-numeric:tabular-nums;
  }
  .lab{color:var(--hud-dim);font-weight:700;font-size:12px;text-transform:uppercase;letter-spacing:.06em}
  .val{color:var(--hud-fg);font-weight:800}
  .boostbar{width:140px;height:10px;border-radius:999px;background:#0b0e13;border:1px solid rgba(255,255,255,.08);overflow:hidden}
  .boostbar>i{display:block;height:100%;width:0%;background:linear-gradient(90deg,#0086ff,#00ffe1);transition:width .12s}

  /* ====== æ“ä½œãƒœã‚¿ãƒ³ï¼ˆä¸‹éƒ¨å›ºå®šï¼‰ ====== */
  .controls{
    position:fixed;left:calc(env(safe-area-inset-left) + 8px);right:calc(env(safe-area-inset-right) + 8px);
    bottom:calc(env(safe-area-inset-bottom) + 8px);
    display:grid;grid-template-columns:1fr .9fr .9fr;gap:10px;
    z-index:15;
  }
  .row2{margin-top:8px;display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .btn{
    -webkit-tap-highlight-color:transparent;
    user-select:none;touch-action:manipulation;cursor:pointer;
    background:var(--btn);border:1px solid rgba(255,255,255,.1);border-radius:16px;
    padding:14px 12px;color:#fff;font-weight:800;text-align:center;box-shadow:var(--shadow);
  }
  .btn:active{transform:translateY(1px)}
  .btn[disabled]{opacity:.45;filter:grayscale(.4);pointer-events:none}
  .btn.boost{background:linear-gradient(180deg,#0f1320,#171c2b)}
  .slot{position:relative}
  .slot small{position:absolute;right:8px;top:6px;color:#cbd1d8;opacity:.8;font-size:11px}
  .slot .icon{display:block;height:22px;opacity:.85;margin-bottom:4px}
  .slot .label{font-size:13px}
  .ghost{opacity:.25}

  /* ====== ç”»é¢å†…ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ ====== */
  .overlay{
    position:fixed;inset:0;display:flex;align-items:center;justify-content:center;
    background:rgba(0,0,0,.6);z-index:30;backdrop-filter:blur(2px);
  }
  .card{
    width:min(560px,90vw);padding:20px;border-radius:14px;background:#0e1117;color:#fff;
    box-shadow:var(--shadow);text-align:center
  }
  .card h1{margin:6px 0 12px;font-size:20px}
  .card .lg{font-size:42px;font-weight:900;letter-spacing:.02em}
  .card .md{font-size:28px;font-weight:900}
  .row{display:flex;gap:10px;flex-wrap:wrap;justify-content:center;margin-top:14px}
  .chip{
    -webkit-tap-highlight-color:transparent;
    cursor:pointer;user-select:none;
    padding:10px 12px;border-radius:12px;background:#151a22;border:1px solid rgba(255,255,255,.08);font-weight:800
  }
  .chip:active{transform:translateY(1px)}
  .op{position:fixed;inset:0;background:#000;display:flex;align-items:center;justify-content:center;z-index:35}
  .op img{max-width:100%;max-height:100%;object-fit:contain}
  .countdown{
    position:fixed;inset:0;display:flex;align-items:center;justify-content:center;
    color:#fff;font-weight:900;font-size:min(22vw,120px);z-index:32;text-shadow:0 0 24px rgba(0,0,0,.8)
  }
  .cutin{
    position:fixed;inset:0;display:flex;align-items:center;justify-content:center;z-index:28;
    pointer-events:none
  }
  .cutin img{width:min(70vw,640px);height:auto;opacity:.0;animation:fadeCut 2s ease forwards}
  @keyframes fadeCut{0%{opacity:0} 20%{opacity:1} 80%{opacity:1} 100%{opacity:0}}

  /* ====== å°ã•ã‚ç«¯æœ«ã§ã®é…ç½®èª¿æ•´ ====== */
  @media (max-width:420px){
    .btn{padding:12px 10px}
    .boostbar{width:120px}
  }
</style>
</head>
<body>
<div id="wrap">
  <canvas id="cv" width="1280" height="720"></canvas>
  <!-- ===== HUD ===== -->
  <div class="hud" id="hud">
    <div class="grp">
      <div class="pill"><span class="lab">è·é›¢</span>&nbsp;<span class="val" id="uiDist">0 m</span></div>
      <div class="pill"><span class="lab">é€Ÿåº¦</span>&nbsp;<span class="val" id="uiSpeed">0 km/h</span></div>
      <div class="pill"><span class="lab">ã‚¸ãƒ£ãƒ³ãƒ—</span>&nbsp;<span class="val" id="uiJump">0/2</span></div>
      <div class="pill"><span class="lab">ã‚³ã‚¤ãƒ³</span>&nbsp;<span class="val" id="uiCoin">0</span></div>
    </div>
    <div class="grp">
      <div class="pill" style="gap:10px">
        <span class="lab">ãƒ–ãƒ¼ã‚¹ãƒˆ</span>
        <div class="boostbar"><i id="uiBoost"></i></div>
      </div>
    </div>
  </div>

  <!-- ===== Controls ===== -->
  <div class="controls" id="ctrls">
    <button class="btn" id="btnJump">ã‚¸ãƒ£ãƒ³ãƒ—</button>
    <button class="btn boost" id="btnBoost">ãƒ–ãƒ¼ã‚¹ãƒˆ</button>
    <div class="row2">
      <button class="btn slot" id="btnItem1"><small>ITEM 1</small><img class="icon ghost" id="itemIcon1" alt="" /></button>
      <button class="btn slot" id="btnItem2"><small>ITEM 2</small><img class="icon ghost" id="itemIcon2" alt="" /></button>
    </div>
  </div>

  <!-- ===== Overlays (runtimeã§å‡ºã—å…¥ã‚Œ) ===== -->
  <div class="op" id="op" hidden><img id="opImg" alt="op"></div>
  <div class="countdown" id="countdown" hidden>3</div>
  <div class="cutin" id="cutin" hidden><img id="cutinImg" alt=""></div>

  <div class="overlay" id="modal" hidden>
    <div class="card">
      <div class="lg" id="modalMain">è¨˜éŒ² 0 mï¼</div>
      <div class="row">
        <div class="chip" data-act="restart">ã‚¹ã‚¿ãƒ¼ãƒˆ</div>
        <div class="chip" data-act="choose">ã‚­ãƒ£ãƒ©é¸æŠ</div>
        <div class="chip" data-act="quit">ã‚„ã‚ã‚‹</div>
      </div>
    </div>
  </div>
</div>

<script>
/* =========================================================
   ã‚¹ãƒãƒ›å…¨ç”»é¢ & iPhone Safari ã®å®‰å…¨é ˜åŸŸã«é…æ…®
========================================================= */
(() => {
  const cv = document.getElementById('cv');
  const fit = () => {
    // ã‚­ãƒ£ãƒ³ãƒã‚¹ã¯å¸¸ã«ç”»é¢ã‚µã‚¤ã‚ºã«åˆã‚ã›ã‚‹ï¼ˆæç”»å†…ã‚¹ã‚±ãƒ¼ãƒ«ã¨ç‹¬ç«‹ï¼‰
    const dpr = Math.max(1, Math.min(window.devicePixelRatio || 1, 2));
    const w = Math.floor(window.innerWidth * dpr);
    const h = Math.floor(window.innerHeight * dpr);
    cv.width = w; cv.height = h;
  };
  window.addEventListener('resize', fit, {passive:true});
  window.addEventListener('orientationchange', fit, {passive:true});
  fit();
})();

/* =========================================================
   ã‚¢ã‚»ãƒƒãƒˆèª­ã¿è¾¼ã¿ï¼ˆãƒ•ã‚¡ã‚¤ãƒ«åã¯æŒ‡å®šã©ãŠã‚Šï¼šå¤§å°æ–‡å­—å³å®ˆï¼‰
========================================================= */
const IMG_NAMES = {
  sky: 'sora.PNG', field:'hatake2.png', road:'do-ro.png',
  corn:'corn.PNG', pipe:'dokan.png', ramp:'jumpdai.png',
  signs:['kanban1.png','kanban2.png','kanban3.png','kanban4.png','kanban5.png','kanban6.png'],
  coin:'coin.png', gold:'gold.png', star1:'hoshi1.png', star2:'hoshi2.png',
  invOP:'mutekiop.png', // ç„¡æ•µã‚«ãƒƒãƒˆã‚¤ãƒ³
  viran:'viran.png', viranOP:'viran op.png', fire:'tama.png',
  itemWing:'tsubasa.png', itemJump:'jump.png', itemEn:'en.png',
  charA:'orange.png', charB:'VR.png',
  op:'op.png'
};
const IMGS = {};
function loadImages(done){
  const list = [];
  for(const k in IMG_NAMES){
    if(Array.isArray(IMG_NAMES[k])) IMG_NAMES[k].forEach(n=>list.push([`${k}:${n}`, n]));
    else list.push([k, IMG_NAMES[k]]);
  }
  let left = list.length;
  const onend = () => (--left<=0 && done());
  list.forEach(([key, src])=>{
    const img = new Image();
    img.onload = onend; img.onerror = onend;
    img.src = src;
    // è¤‡æ•°çœ‹æ¿ã¯ key ã« "signs:xxx" å½¢å¼ãŒæ¥ã‚‹
    if(key.startsWith('signs:')){
      if(!IMGS.signs) IMGS.signs = [];
      IMGS.signs.push(img);
    }else{
      IMGS[key] = img;
    }
  });
}

/* =========================================================
   ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
========================================================= */
const clamp=(v,a,b)=>v<a?a:v>b?b:v;
const rand=(a,b)=>Math.random()*(b-a)+a;
const randi=(a,b)=>Math.floor(rand(a,b+1));
const chance=(p)=>Math.random()<p;
const now_ms=()=>performance.now();
const easeOut=(t)=>1- Math.pow(1-t,2);
const lerp=(a,b,t)=>a+(b-a)*t;

/* =========================================================
   ã‚²ãƒ¼ãƒ å®šæ•°ï¼ˆè¦‹ã‚„ã™ã„ã‚ˆã†ã«ã¾ã¨ã‚ï¼‰
========================================================= */
const G = {
  gravity: 2600,                  // è½ä¸‹åŠ é€Ÿåº¦(px/s^2)
  runSpeed: 480,                  // é€šå¸¸èµ°è¡Œ(px/s)
  maxSpeed: 820,                  // ãƒ–ãƒ¼ã‚¹ãƒˆæ™‚ä¸Šé™
  boostFillPerSec: 12,            // ãƒ–ãƒ¼ã‚¹ãƒˆã‚²ãƒ¼ã‚¸è‡ªç„¶å›å¾©(%/s)
  boostDrainPerSec: 40,           // ãƒ–ãƒ¼ã‚¹ãƒˆæ¶ˆè²»(%/s)
  boostTimeHard: 2.5,             // å³æ™‚ãƒ–ãƒ¼ã‚¹ãƒˆï¼ˆãƒœã‚¿ãƒ³æ™‚ã®å¼·åŒ–æ‰±ã„ï¼‰
  coinToInv: 10,                  // ç„¡æ•µç™ºå‹•ã‚³ã‚¤ãƒ³æ•°
  invTime: 5.0,                   // ç„¡æ•µ5ç§’
  itemWingTime: 5.0,              // 4æ®µã‚¸ãƒ£ãƒ³ãƒ— 5ç§’
  itemEnTime: 5.0,                // ãƒ–ãƒ¼ã‚¹ãƒˆä½¿ã„æ”¾é¡Œ 5ç§’
  safeStartMeters: 60,            // ã‚¹ã‚¿ãƒ¼ãƒˆç›´å¾Œã¯éšœå®³ç‰©ãªã—
  groundTopRatio: .76,            // ç”»é¢é«˜ã•ã«å¯¾ã™ã‚‹ã€Œé“è·¯ä¸Šç«¯ã€ã®æ¯”ç‡
  pipeCycleUpSec: .85,            // åœŸç®¡ãŒä¼¸ã³ã‚‹æ™‚é–“
  pipeHoldSec: 2.0,               // æœ€é«˜ä½åœæ­¢
  pipeDownSec: .85,               // å¼•ã£è¾¼ã‚€æ™‚é–“
  pipeTopSnapTol: 12,             // ä¸Šé¢å¸ç€è¨±å®¹Â±px
  rampAutoJumpPct: .60,           // æ–œé¢60%åœ°ç‚¹ã§è‡ªå‹•ã‚¸ãƒ£ãƒ³ãƒ—
  rampKickVY: 1050,               // ã‚¦ã‚§ãƒƒã‚¸ã‚¸ãƒ£ãƒ³ãƒ—ä¸Šå‘ãé€Ÿåº¦
  rampKickVX: 140,                // ã‚¦ã‚§ãƒƒã‚¸ã§ã®åŠ é€Ÿ
  signRareP: .002,                // çœ‹æ¿ãƒ¬ã‚¢å‡ºç¾ï¼ˆãƒ•ãƒ¬ãƒ¼ãƒ æ¯åˆ¤å®šï¼‰
  coinRareP: .004,                // ã‚³ã‚¤ãƒ³å‡ºç¾ã‹ãªã‚Šä½ã‚
  itemRareP: .0015,               // ã‚¢ã‚¤ãƒ†ãƒ å‡ºç¾ rarer
  fireballSize: 64,               // ç«ã®ç‰ã‚µã‚¤ã‚ºï¼ˆè¦‹ãŸç›®å¤§ãã‚ï¼‰
  villIntervalMin: 500,           // ãƒ´ã‚£ãƒ©ãƒ³å‡ºç¾è·é›¢ï¼ˆmï¼‰
  villIntervalMax: 1000,
  villDescendSpeed: 50,           // å¤©ã‹ã‚‰ã‚†ã£ãã‚Šé™ã‚Šã‚‹(px/s)
  villHoverYRatio: .45,           // ç›®æ¨™é«˜ã•ï¼ˆç”»é¢æ¯”ï¼‰
  villAheadXRatio: .42,           // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼å‰æ–¹ã«å¸¸ã«ä½ç½®å–ã‚‹ï¼ˆè¿½ã„è¶Šã•ã‚Œãªã„ï¼‰
  villFiresMin: 5, villFiresMax: 8,
  villFireDelayMin:.6, villFireDelayMax:1.6
};

/* =========================================================
   ã‚²ãƒ¼ãƒ çŠ¶æ…‹
========================================================= */
const State = {
  LOADING:0, OP:1, COUNT:2, RUN:3, OVER:4, PAUSE:5
};
let state = State.LOADING;

const cv = document.getElementById('cv');
const cx = cv.getContext('2d');
let vw=cv.width, vh=cv.height, dpr=1;
function syncCanvasMetrics(){
  vw=cv.width; vh=cv.height; dpr = Math.max(1, Math.min(window.devicePixelRatio||1, 2));
}
syncCanvasMetrics();
addEventListener('resize', ()=>{syncCanvasMetrics()});

/* =========================================================
   ãƒ¯ãƒ¼ãƒ«ãƒ‰ï¼ˆã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒ»åœ°å½¢ï¼‰
========================================================= */
let scrollX = 0;             // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ä½ç½®ï¼ˆpxï¼‰
let meters = 0;              // è·é›¢ï¼ˆm æ›ç®—ï¼‰
let speed = G.runSpeed;      // ç¾åœ¨é€Ÿåº¦ï¼ˆpx/sï¼‰
let kmh = 0;                 // è¡¨ç¤ºç”¨ km/h
let groundY = 0;             // é“è·¯ã®ä¸Šç«¯Yï¼ˆæ¥åœ°ãƒ©ã‚¤ãƒ³ï¼‰
let patterns = {sky:null,field:null,road:null};

function updateGroundY(){
  groundY = Math.floor(vh * G.groundTopRatio);
}
function makePatterns(){
  const mk=(img)=> img && cx.createPattern(img,'repeat');
  patterns.sky = mk(IMGS.sky);
  patterns.field = mk(IMGS.field);
  patterns.road = mk(IMGS.road);
}
function drawBackground(){
  // ãƒ‘ãƒ©ãƒ©ãƒƒã‚¯ã‚¹ï¼šç©º(æœ€å¥¥)ãƒ»ç•‘(ä¸­)ãƒ»é“è·¯(å‰)
  const skyH = Math.floor(vh*0.55);
  const fieldH = Math.floor(vh*0.30);
  const roadH = vh - groundY + Math.floor(vh*0.12);

  // ç©º
  if(patterns.sky){
    cx.save();
    cx.translate(- (scrollX*0.18)%vw, 0);
    cx.fillStyle = patterns.sky; cx.fillRect(-vw, 0, vw*3, skyH);
    cx.restore();
  } else { cx.fillStyle='#102133'; cx.fillRect(0,0,vw,skyH); }

  // ç•‘ï¼ˆä¸Šç«¯ã‚’ç©ºã¨é“è·¯ã®é–“ã«ï¼‰
  if(patterns.field){
    const y = skyH - 8;
    cx.save();
    cx.translate(- (scrollX*0.45)%vw, y);
    cx.fillStyle = patterns.field; cx.fillRect(-vw, 0, vw*3, fieldH);
    cx.restore();
  } else {
    cx.fillStyle='#214016'; cx.fillRect(0, skyH-8, vw, fieldH);
  }

  // é“è·¯ï¼ˆä¸Šç«¯ã¯ groundY ã¨ãƒ”ã‚¿ä»˜ã‘ï¼â€œæµ®ã„ã¦è¦‹ãˆãªã„â€ï¼‰
  if(patterns.road){
    const y = groundY;
    cx.save();
    cx.translate(- (scrollX)%vw, y);
    cx.fillStyle = patterns.road; cx.fillRect(-vw, 0, vw*3, roadH);
    cx.restore();
  } else {
    cx.fillStyle='#2b2b2b'; cx.fillRect(0, groundY, vw, roadH);
  }
}

/* =========================================================
   ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼
========================================================= */
const CHAR = { A:'A', B:'B' };
let selectedChar = CHAR.A;
const player = {
  xRatio:.22, x:0, y:0, w:64, h:72,
  vy:0, onGround:false, onRamp:null, rampT:0,
  jumpsLeft:2, maxJumps:2,
  alive:true, inv:false, invUntil:0,
  wingsUntil:0, enUntil:0,
  boost:0, boosting:false, boostHold:false,
  coins:0, starsAnim:0,
};
function resetPlayer(){
  player.w = 72; player.h = 80; // å¤šå°‘å¤§ãã‚
  player.x = Math.floor(vw*player.xRatio);
  player.y = groundY - player.h;
  player.vy = 0;
  player.onGround = true; player.onRamp=null; player.rampT=0;
  player.jumpsLeft = player.maxJumps = 2;
  player.alive = true; player.inv=false; player.invUntil=0;
  player.wingsUntil=0; player.enUntil=0;
  player.boost = 0; player.boosting=false; player.boostHold=false;
  player.coins = 0; player.starsAnim=0;
}

/* =========================================================
   ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆé¡
========================================================= */
const OBJ = {
  CORN:'CORN',
  PIPE:'PIPE',
  RAMP:'RAMP',
  SIGN:'SIGN',
  COIN:'COIN',
  ITEM:'ITEM',
  FIRE:'FIRE' // æ®‹ç•™ç«ã®ç‰
};
let objects = [];        // ã‚³ãƒ¼ã‚¹ä¸Šã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ï¼ˆx ã¯ãƒ¯ãƒ¼ãƒ«ãƒ‰åº§æ¨™ï¼‰

// ç”Ÿæˆãƒ˜ãƒ«ãƒ‘
function spawnCorn(x){
  const size = Math.max(56, player.h*0.9); // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãã‚‰ã„ã®ã‚µã‚¤ã‚º
  objects.push({type:OBJ.CORN, x, y:groundY-size, w:size, h:size, deadly:true});
}
function spawnPipe(x){
  // åˆæœŸã¯åœ°é¢ã‹ã‚‰å°‘ã—è¦‹ãˆã‚‹çŠ¶æ…‹
  const w=72, hMax = Math.max(120, player.h*1.2);
  objects.push({
    type:OBJ.PIPE, x, baseY:groundY, w, h:24, hMax,
    phase:'up', t:0, y:groundY-24, deadlySide:true, topRide:true
  });
}
function updatePipe(o, dt){
  if(o.phase==='up'){ o.t+=dt; const k = clamp(o.t/G.pipeCycleUpSec,0,1); o.h = lerp(24,o.hMax,k); o.y = o.baseY - o.h; if(k>=1){o.phase='hold';o.t=0;} }
  else if(o.phase==='hold'){ o.t+=dt; o.h=o.hMax; o.y = o.baseY - o.h; if(o.t>=G.pipeHoldSec){o.phase='down';o.t=0;} }
  else if(o.phase==='down'){ o.t+=dt; const k=clamp(o.t/G.pipeDownSec,0,1); o.h = lerp(o.hMax,24,k); o.y = o.baseY - o.h; if(k>=1){o.phase='up';o.t=0;} }
}
function spawnRamp(x){
  const w = 160, h = 90; // ä¸‰è§’ã‚¦ã‚§ãƒƒã‚¸
  objects.push({type:OBJ.RAMP, x, y:groundY-h, w, h, deadly:false});
}
function spawnSign(x){
  // èµ°è¡Œåœ°é¢ï¼ˆé“è·¯ï¼‰ä¸Šã«ã´ã£ãŸã‚Šã€‚æµ®ã„ã¦è¦‹ãˆãªã„ã‚ˆã†ã«ã€‚
  const img = IMGS.signs[ randi(0, IMGS.signs.length-1) ];
  const h = Math.min( Math.floor(vh*0.22), img?.naturalHeight || 160 );
  const scale = h / (img?.naturalHeight || h);
  const w = Math.floor((img?.naturalWidth || (h*1.6)) * scale);
  const y = groundY - h; // åœ°é¢ã«æ¥åœ°
  objects.push({type:OBJ.SIGN, x, y, w, h, img});
}
function spawnCoin(x){
  const s = 44;
  objects.push({type:OBJ.COIN, x, y:groundY - s - randi(40, 140), w:s, h:s});
}
function spawnItem(x){
  const s = 52;
  const kinds = ['wing','jump','en'];
  const k = kinds[randi(0,2)];
  objects.push({type:OBJ.ITEM, kind:k, x, y:groundY - s - randi(80, 180), w:s, h:s, vy: Math.random()<.5? -30 : 30 });
}
function spawnFireResidue(x, yBottom){
  const s = G.fireballSize;
  objects.push({type:OBJ.FIRE, x, y:yBottom - s, w:s, h:s, deadly:true});
}

/* =========================================================
   ãƒ´ã‚£ãƒ©ãƒ³ï¼ˆå‡ºç¾ç®¡ç†ï¼‰
========================================================= */
const villain = {
  alive:false, entering:false, leaving:false, y: -200, x:0,
  targetY:0, firesLeft:0, nextFireAt:0, opShown:false
};
let nextVillAt = 600; // mï¼ˆåˆæœŸå€¤ã¯å¾Œã§ãƒ©ãƒ³ãƒ€ãƒ åŒ–ï¼‰
function scheduleNextVill(){
  nextVillAt = meters + randi(G.villIntervalMin, G.villIntervalMax);
}
function triggerVillain(){
  // ã‚«ãƒƒãƒˆã‚¤ãƒ³
  showCutIn(IMGS.viranOP);
  villain.alive=true; villain.entering=true; villain.leaving=false; villain.opShown=true;
  villain.y = -200;
  villain.firesLeft = randi(G.villFiresMin, G.villFiresMax);
  villain.nextFireAt = now_ms() + randi(600,1300);
}
function updateVillain(dt){
  if(!villain.alive) return;
  // ç”»é¢ä¸Šã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼å‰æ–¹ã«å¸¸ã«å­˜åœ¨ï¼ˆè¿½ã„è¶Šã•ã‚Œãªã„ï¼‰
  const aheadX = Math.floor(vw * G.villAheadXRatio) + scrollX;
  villain.x = aheadX;

  const targetScreenY = Math.floor(vh * G.villHoverYRatio);
  villain.targetY = targetScreenY;

  if(villain.entering){
    // å¤©ã‹ã‚‰ã‚†ã£ãã‚Šé™ã‚Šã¦ãã‚‹
    villain.y += G.villDescendSpeed * dt;
    if(villain.y >= villain.targetY) { villain.y = villain.targetY; villain.entering=false; }
  } else if(villain.leaving){
    villain.y -= G.villDescendSpeed * .8 * dt;
    if(villain.y + 20 < -200){ villain.alive=false; scheduleNextVill(); }
  } else {
    // å¾®å¦™ã«ãµã‚ãµã‚
    villain.y = lerp(villain.y, villain.targetY + Math.sin(now_ms()/900)*8, 0.08);
    // æŠ•ä¸‹ã‚¿ã‚¤ãƒŸãƒ³ã‚°ï¼ˆãƒ©ãƒ³ãƒ€ãƒ ã€é€²è¡Œæ–¹å‘ã«å‰æ–¹è½ä¸‹ï¼‰
    if(villain.firesLeft>0 && now_ms() >= villain.nextFireAt){
      villain.firesLeft--;
      villain.nextFireAt = now_ms() + randi(G.villFireDelayMin*1000, G.villFireDelayMax*1000);
      // å‰æ–¹ã«è½ã¨ã™ï¼šåœ°é¢ã®ä¸Šã«æ®‹ç•™
      const dropAhead = scrollX + Math.floor(vw* (0.18 + Math.random()*0.22));
      // ç«ã®ç‰ã¯è½ä¸‹æ¼”å‡ºã—ã¦ã‹ã‚‰åœ°é¢ã«è¨­ç½®ï¼ˆç°¡æ˜“ï¼šã‚¢ãƒ‹ãƒ¡ç„¡ã—ã§å³åœ°é¢ã¸ç€å¼¾è¡¨ç¾ï¼‰
      spawnFireResidue(dropAhead, groundY);
      // ã¾ã‚Œã«ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼å¯„ã‚Šã«
      if(chance(.25)) spawnFireResidue(dropAhead - randi(40,120), groundY);
    }
    if(villain.firesLeft<=0){
      villain.leaving = true;
    }
  }
}
function drawVillain(){
  if(!villain.alive) return;
  const sx = villain.x - scrollX;
  const sy = villain.y;
  const img = IMGS.viran;
  const w = Math.min( Math.floor(vw*0.22), img?.naturalWidth || 200 );
  const h = Math.floor(w * ( (img?.naturalHeight||200)/(img?.naturalWidth||200) ));
  cx.save();
  cx.imageSmoothingEnabled = false; // æ¨ªä¼¸ã³é˜²æ­¢ï¼ˆã«ã˜ã¿è»½æ¸›ï¼‰
  if(img && img.complete) cx.drawImage(img, sx - w/2, sy - h/2, w, h);
  else { cx.fillStyle='#933'; cx.fillRect(sx-w/2, sy-h/2, w, h); }
  cx.restore();
}

/* =========================================================
   ã‚¢ã‚¤ãƒ†ãƒ æ‰€æŒã‚¹ãƒ­ãƒƒãƒˆ
========================================================= */
const slots = [null,null]; // {kind:'wing'|'jump'|'en', img:Image}
function pushItem(kind){
  const icon = kind==='wing'? IMGS.itemWing : kind==='jump'? IMGS.itemJump : IMGS.itemEn;
  for(let i=0;i<2;i++){
    if(!slots[i]){ slots[i]={kind, img:icon}; refreshItemButtons(); return true; }
  }
  return false; // æº€æ¯
}
function useSlot(i){
  const it = slots[i];
  if(!it) return;
  if(it.kind==='wing'){
    player.wingsUntil = now_ms() + G.itemWingTime*1000;
    player.maxJumps = 4;
    player.jumpsLeft = Math.max(player.jumpsLeft, 4 - (player.onGround?0:(2-player.jumpsLeft))); // ãªã‚‹ã¹ãä½¿ã„ã‚„ã™ã
  }else if(it.kind==='jump'){
    // æœ€å¯„ã‚Šã®è‡´å‘½éšœå®³ï¼ˆã‚³ãƒ¼ãƒ³ï¼åœŸç®¡ï¼‰ã‚’ã‚¸ãƒ£ãƒ³ãƒ—å°åŒ–
    let nearest = null, nd=1e9;
    for(const o of objects){
      if(o.type===OBJ.CORN || o.type===OBJ.PIPE){
        const d = (o.x - (scrollX + player.x));
        if(d>0 && d<nd){ nd=d; nearest=o; }
      }
    }
    if(nearest){
      // ç½®æ›ï¼ˆè¦‹ãŸç›®ã®é•å’Œæ„ŸãŒå‡ºãªã„ã‚ˆã†ã€æ¥åœ°ãƒ©ã‚¤ãƒ³ã«åˆã‚ã›ã‚‹ï¼‰
      const x = nearest.x;
      // å…ƒã®ã¯ç„¡åŠ¹åŒ–
      nearest.type='__REMOVED__';
      spawnRamp(x);
    }
  }else if(it.kind==='en'){
    player.enUntil = now_ms() + G.itemEnTime*1000;
  }
  slots[i]=null; refreshItemButtons();
}
function refreshItemButtons(){
  const b1=document.getElementById('btnItem1'), b2=document.getElementById('btnItem2');
  const i1=document.getElementById('itemIcon1'), i2=document.getElementById('itemIcon2');
  const set=(btn,imgEl,slot)=>{
    if(slot){
      imgEl.src = slot.img?.src || '';
      imgEl.classList.remove('ghost');
      btn.removeAttribute('disabled');
    }else{
      imgEl.removeAttribute('src'); imgEl.classList.add('ghost');
      btn.setAttribute('disabled','');
    }
  };
  set(b1,i1,slots[0]); set(b2,i2,slots[1]);
}

/* =========================================================
   è¡çªåˆ¤å®šãƒ»æ¥åœ°
========================================================= */
function aabb(a,b){ return a.x < b.x + b.w && a.x + a.w > b.x && a.y < b.y + b.h && a.y + a.h > b.y; }

// ramp ä¸Šé¢å½¢çŠ¶ï¼šå·¦ä¸Š( x, y+h ), å³ä¸Š( x+w, y ) ã®ç›´ç·š
function onRampTop(o, pxCenter, pyBottom){
  const t = clamp( (pxCenter - o.x) / o.w, 0, 1 );
  const rampTopY = o.y + (1-t)*o.h; // å³ã»ã©é«˜ã„ã‚¦ã‚§ãƒƒã‚¸
  return {t, y:rampTopY};
}

/* =========================================================
   ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«
========================================================= */
const btnJump = document.getElementById('btnJump');
const btnBoost = document.getElementById('btnBoost');
document.getElementById('btnItem1').addEventListener('click', ()=>useSlot(0));
document.getElementById('btnItem2').addEventListener('click', ()=>useSlot(1));
btnJump.addEventListener('click', onJump);
btnBoost.addEventListener('click', onBoostDown);
btnBoost.addEventListener('touchstart', onBoostDown, {passive:true});
btnBoost.addEventListener('touchend', onBoostUp, {passive:true});
btnBoost.addEventListener('mouseup', onBoostUp);
function onJump(){
  if(!player.alive || state!==State.RUN) return;
  // ramp ä¸­ã¯å°‘ã—è§’åº¦ã«æ²¿ã£ã¦ä¸ŠãŒã‚‹ã®ã§ã€é€šå¸¸ã‚¸ãƒ£ãƒ³ãƒ—ã®ä¸Šæ›¸ãæŠ‘åˆ¶
  if(player.jumpsLeft>0){
    player.vy = - ( player.onRamp ? (G.rampKickVY*0.72) : 980 );
    player.jumpsLeft--;
  }
}
function onBoostDown(){
  if(state!==State.RUN) return;
  player.boostHold = true;
}
function onBoostUp(){
  player.boostHold = false;
}

/* =========================================================
   OP/ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³/ã‚«ãƒƒãƒˆã‚¤ãƒ³
========================================================= */
const elOP = document.getElementById('op');
const elOPImg = document.getElementById('opImg');
const elCD = document.getElementById('countdown');
const elCut = document.getElementById('cutin');
const elCutImg = document.getElementById('cutinImg');
function showOP(){
  elOPImg.src = IMGS.op?.src || '';
  elOP.hidden=false;
  setTimeout(()=>{ elOP.hidden=true; autoChooseChar(); startCountDown(); }, 2000);
}
function showCutIn(img){
  elCutImg.src = img?.src || '';
  elCut.hidden=false;
  setTimeout(()=>{ elCut.hidden=true; }, 2000);
}
function startCountDown(){
  state = State.COUNT;
  let n=3;
  elCD.hidden=false; elCD.textContent = '3';
  const tick=()=>{
    if(n>0){ elCD.textContent = String(n); n--; setTimeout(tick, 700); }
    else{ elCD.textContent='GO'; setTimeout(()=>{ elCD.hidden=true; startRun(); }, 500); }
  };
  setTimeout(tick, 700);
}

/* =========================================================
   ã‚²ãƒ¼ãƒ é–‹å§‹/å†é–‹/çµ‚äº†
========================================================= */
const elModal = document.getElementById('modal');
elModal.addEventListener('click', (e)=>{
  const act = e.target?.dataset?.act;
  if(!act) return;
  if(act==='restart'){ elModal.hidden=true; autoChooseChar(false); startCountDown(); }
  else if(act==='choose'){ elModal.hidden=true; chooseChar(); }
  else if(act==='quit'){ elModal.hidden=true; hardReset(); }
});
function hardReset(){
  // ã‚¿ã‚¤ãƒˆãƒ«(OP)ã«æˆ»ã™
  scrollX=0; meters=0; speed=G.runSpeed; kmh=0; objects.length=0; scheduleNextVill();
  villain.alive=false; villain.entering=false; villain.leaving=false; villain.opShown=false;
  slots[0]=slots[1]=null; refreshItemButtons();
  resetPlayer();
  state = State.OP;
  showOP();
}
function autoChooseChar(randomize=true){
  selectedChar = randomize ? (chance(.5)?CHAR.A:CHAR.B) : selectedChar;
}
function chooseChar(){
  state = State.PAUSE;
  const card = document.createElement('div');
  card.className='card';
  card.innerHTML=`
    <h1>ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼é¸æŠ</h1>
    <div class="row">
      <div class="chip" data-c="A">ğŸŠ orange.png</div>
      <div class="chip" data-c="B">ğŸ® VR.png</div>
    </div>
  `;
  const lay = document.createElement('div');
  lay.className='overlay';
  lay.appendChild(card);
  document.body.appendChild(lay);
  const pick = (c)=>{
    selectedChar = c; document.body.removeChild(lay); startCountDown();
  };
  card.addEventListener('click', e=>{
    const c = e.target?.dataset?.c;
    if(c==='A'||c==='B') pick(c);
  });
}

/* =========================================================
   ãƒ©ãƒ³é–‹å§‹ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
========================================================= */
let lastT = 0;
function startRun(){
  // åœ°å½¢
  updateGroundY(); makePatterns();

  // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼
  resetPlayer();

  // ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆåˆæœŸåŒ–ï¼ˆå®‰å…¨åœ°å¸¯ï¼‰
  objects.length=0;
  const startPad = meters + G.safeStartMeters;

  // æœ€åˆã®éšœå®³ã¯å®‰å…¨åœ°å¸¯ã®å…ˆã‹ã‚‰
  let x = scrollX + vw + 240;
  for(let i=0;i<10;i++){
    x += randi(220, 420);
    spawnCorn(x);
    if(chance(.5)) spawnPipe(x + randi(160,260));
    if(chance(.4)) spawnRamp(x + randi(300,480));
  }

  scheduleNextVill();
  state = State.RUN;
  lastT = now_ms();
}

/* =========================================================
   ã‚¹ãƒãƒ¼ãƒ³ï¼ˆãƒ©ãƒ³ãƒ€ãƒ ï¼‰
========================================================= */
function randomSpawns(){
  // çœ‹æ¿ï¼ˆç¨€ï¼šç•‘ã®å³ç«¯ã‹ã‚‰ã§ã¯ãªãã€åœ°é¢ã«ãã‚Œã„ã«ç«‹ã¦ã‚‹ä»•æ§˜ã«å¤‰æ›´ï¼‰
  if(chance(G.signRareP)){
    const x = scrollX + vw + randi(80, 260);
    spawnSign(x);
  }
  // ã‚³ã‚¤ãƒ³ï¼ˆã‹ãªã‚Šãƒ¬ã‚¢ï¼‰
  if(chance(G.coinRareP)){
    const x = scrollX + vw + randi(140, 340);
    spawnCoin(x);
  }
  // ã‚¢ã‚¤ãƒ†ãƒ ï¼ˆãƒ¬ã‚¢ï¼ãµã‚ãµã‚ï¼‰
  if(chance(G.itemRareP)){
    const x = scrollX + vw + randi(240, 520);
    spawnItem(x);
  }
  // é€šå¸¸éšœå®³ï¼ˆé–“éš”ï¼‰
  if(chance(0.035)){
    const x = scrollX + vw + randi(260, 560);
    const r = Math.random();
    if(r<.45) spawnCorn(x);
    else if(r<.78) spawnPipe(x);
    else spawnRamp(x);
  }
}

/* =========================================================
   æ¯ãƒ•ãƒ¬ãƒ¼ãƒ æ›´æ–°
========================================================= */
function update(dt){
  if(state!==State.RUN) return;

  // ã‚¹ãƒ”ãƒ¼ãƒ‰åˆ¶å¾¡ï¼ˆãƒ–ãƒ¼ã‚¹ãƒˆï¼‰
  const canBoost = (player.boost>0) || (now_ms() < player.enUntil);
  const wantBoost = player.boostHold && canBoost;
  player.boosting = wantBoost;
  if(wantBoost){
    speed = lerp(speed, G.maxSpeed, 0.15);
    if(now_ms() >= player.enUntil){
      player.boost = clamp(player.boost - G.boostDrainPerSec*dt, 0, 100);
    }
  }else{
    speed = lerp(speed, G.runSpeed, 0.10);
    // è‡ªç„¶å›å¾©
    player.boost = clamp(player.boost + G.boostFillPerSec*dt, 0, 100);
  }

  // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ« & è·é›¢
  scrollX += speed * dt;
  meters = Math.floor(scrollX / 100 * 6); // ã–ã£ãã‚Š 1px â‰’ 0.06m
  kmh = Math.round(speed * 3.6 / dpr * 0.6); // è¡¨ç¤ºç”¨

  // ãƒ©ãƒ³ãƒ€ãƒ ã‚¹ãƒãƒ¼ãƒ³
  randomSpawns();

  // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ç‰©ç†
  player.vy += G.gravity * dt;
  let nextY = player.y + player.vy * dt;
  player.onGround=false; player.onRamp=null;

  // ramp å…ˆåˆ¤å®š
  for(const o of objects){
    if(o.type===OBJ.RAMP){
      // è¶³å…ƒãŒ ramp ä¸Šãªã‚‰ã€ãã®ä¸Šé¢ã«å¸ç€
      const pxC = player.x + player.w*0.5;
      if(pxC>=o.x && pxC<=o.x+o.w){
        const info = onRampTop(o, pxC, player.y+player.h);
        const top = info.y;
        const pyBtmNext = nextY + player.h;
        if(pyBtmNext >= top-2 && pyBtmNext <= top+28){
          // ãƒ©ãƒ³ãƒ—ä¸Šé¢
          nextY = top - player.h;
          player.vy = 0;
          player.onRamp = o; player.rampT = info.t;
          // è‡ªå‹•ã‚¸ãƒ£ãƒ³ãƒ—ã‚¾ãƒ¼ãƒ³ï¼ˆ60%åœ°ç‚¹ï¼‰
          if(info.t >= G.rampAutoJumpPct && info.t < G.rampAutoJumpPct+0.05){
            player.vy = -G.rampKickVY;
            speed = clamp(speed + G.rampKickVX, 0, G.maxSpeed);
          }
        }
      }
    }
  }

  // pipe å¸ç€
  for(const o of objects){
    if(o.type===OBJ.PIPE){
      // ä¸Šé¢ã«Â±12pxå¸ç€
      const pxC = player.x + player.w*0.5;
      if(pxC >= o.x && pxC <= o.x+o.w){
        const top = o.y;
        const pyBtmNext = nextY + player.h;
        if(Math.abs(pyBtmNext - top) <= G.pipeTopSnapTol && player.vy>=0){
          nextY = top - player.h;
          player.vy = 0;
          player.onGround=true; // æ‰±ã„ä¸Šâ€œåœ°é¢â€
        }
      }
    }
  }

  // åœ°é¢å¸ç€
  if(nextY + player.h >= groundY){
    nextY = groundY - player.h;
    player.vy = 0;
    player.onGround = true;
  }

  // ã‚¸ãƒ£ãƒ³ãƒ—å›æ•°ç®¡ç†
  if(player.onGround){
    player.maxJumps = (now_ms()<player.wingsUntil)?4:2;
    player.jumpsLeft = player.maxJumps;
  }

  player.y = nextY;

  // åœŸç®¡ã‚¢ãƒ‹ãƒ¡
  for(const o of objects){
    if(o.type===OBJ.PIPE) updatePipe(o, dt);
  }

  // ã‚¢ã‚¤ãƒ†ãƒ ãµã‚ãµã‚
  for(const o of objects){
    if(o.type===OBJ.ITEM){
      o.y += o.vy * dt;
      if(o.y < groundY - 220) o.vy = Math.abs(o.vy);
      if(o.y > groundY - 80)  o.vy = -Math.abs(o.vy);
    }
  }

  // ãƒ´ã‚£ãƒ©ãƒ³ç®¡ç†
  if(meters >= nextVillAt && !villain.alive){
    // ã¾ãšã‚«ãƒƒãƒˆã‚¤ãƒ³â†’ãã®ã¾ã¾å…¥å ´
    triggerVillain();
  }
  updateVillain(dt);

  // è¡çª & å–å¾—
  const pBB = {x: scrollX + player.x, y: player.y, w:player.w, h:player.h};
  for(const o of objects){
    if(o.type==='__REMOVED__') continue;
    const bb = {x:o.x, y:o.y, w:o.w, h:o.h};
    const hit = aabb(pBB, bb);

    if(o.type===OBJ.COIN){
      if(hit){
        o.type='__REMOVED__';
        player.coins++;
        if(player.coins % G.coinToInv === 0){
          // ç„¡æ•µ5ç§’ + ã‚«ãƒƒãƒˆã‚¤ãƒ³
          player.inv = true; player.invUntil = now_ms() + G.invTime*1000;
          showCutIn(IMGS.invOP);
        }
      }
    }
    else if(o.type===OBJ.ITEM){
      if(hit){
        // 2æ æº€æ¯ãªã‚‰å–å¾—ä¸å¯ï¼ˆãã®ã¾ã¾ï¼‰
        const ok = pushItem(o.kind);
        if(ok) o.type='__REMOVED__';
      }
    }
    else if(o.type===OBJ.SIGN){
      // å½“ãŸã‚Šãªã—ï¼ˆé£¾ã‚Šï¼‰
    }
    else if(o.type===OBJ.RAMP){
      // ramp ã¯ä¸Šã§å‡¦ç†ã€æ¨ªè¡çªã¯è‡´å‘½ãªã—ï¼ˆä¹—ã‚‹ç”¨ï¼‰
    }
    else {
      // è‡´å‘½ï¼šCORN, PIPE, FIRE
      if(hit){
        const fromSide = (pBB.x + pBB.w) <= (o.x + 12) || (pBB.x >= (o.x + o.w - 12));
        const isPipeSide = (o.type===OBJ.PIPE) ? fromSide : false;

        if(player.inv){
          // ç„¡æ•µãªã‚‰ç„¡è¦–
        } else if(o.type===OBJ.PIPE && !isPipeSide){
          // ä¸Šã‹ã‚‰ãªã‚‰ä¹—ã‚Œã‚‹ï¼ˆã™ã§ã«å¸ç€å‡¦ç†æ¸ˆã¿ï¼‰
        } else {
          // ã‚¢ã‚¦ãƒˆ
          gameOver();
          return;
        }
      }
    }
  }

  // ç„¡æ•µçµ‚äº†ãƒã‚§ãƒƒã‚¯
  if(player.inv && now_ms() >= player.invUntil){ player.inv=false; }

  // ç”»é¢å¤–ã‚¯ãƒªãƒ¼ãƒ‹ãƒ³ã‚°
  objects = objects.filter(o => (o.type!=='__REMOVED__') && (o.x > scrollX - vw*0.5));

  // UIæ›´æ–°
  updateHUD();
}

/* =========================================================
   æç”»
========================================================= */
function draw(){
  cx.clearRect(0,0,vw,vh);
  drawBackground();

  // çœ‹æ¿ãªã©å¥¥/æ‰‹å‰ãƒ¬ã‚¤ãƒ¤ã‚’åˆ†ã‘ã‚‹ãªã‚‰ã“ã“ã§ï¼ˆã‚·ãƒ³ãƒ—ãƒ«ã«åŒã˜ã§OKï¼‰
  // ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆæç”»ï¼ˆã‚¹ã‚¯ãƒªãƒ¼ãƒ³åº§æ¨™ = obj.x - scrollXï¼‰
  for(const o of objects){
    const sx = Math.floor(o.x - scrollX);
    const sy = Math.floor(o.y);
    if(sx > vw || sx + o.w < -10) continue;

    cx.save(); cx.imageSmoothingEnabled=false;

    if(o.type===OBJ.COIN){
      const img=IMGS.coin;
      if(img && img.complete) cx.drawImage(img, sx, sy, o.w, o.h);
      else { cx.fillStyle='#ffcc00'; cx.fillRect(sx,sy,o.w,o.h); }
    }
    else if(o.type===OBJ.ITEM){
      const img = o.kind==='wing'? IMGS.itemWing : o.kind==='jump'? IMGS.itemJump : IMGS.itemEn;
      if(img && img.complete) cx.drawImage(img, sx, sy, o.w, o.h);
      else { cx.fillStyle='#6cf'; cx.fillRect(sx,sy,o.w,o.h); }
    }
    else if(o.type===OBJ.SIGN){
      const img=o.img;
      if(img && img.complete) cx.drawImage(img, sx, sy, o.w, o.h);
      else { cx.fillStyle='#955'; cx.fillRect(sx,sy,o.w,o.h); }
    }
    else if(o.type===OBJ.CORN){
      const img=IMGS.corn;
      if(img && img.complete) cx.drawImage(img, sx, sy, o.w, o.h);
      else { cx.fillStyle='#fa0'; cx.fillRect(sx,sy,o.w,o.h); }
    }
    else if(o.type===OBJ.PIPE){
      const img=IMGS.pipe;
      if(img && img.complete) cx.drawImage(img, sx, sy, o.w, o.h);
      else { cx.fillStyle='#3a6'; cx.fillRect(sx,sy,o.w,o.h); }
    }
    else if(o.type===OBJ.RAMP){
      const img=IMGS.ramp;
      if(img && img.complete) cx.drawImage(img, sx, sy, o.w, o.h);
      else {
        // ä¸‰è§’æç”»
        cx.fillStyle='#68c';
        cx.beginPath();
        cx.moveTo(sx, sy+o.h);
        cx.lineTo(sx+o.w, sy);
        cx.lineTo(sx+o.w, sy+o.h);
        cx.closePath(); cx.fill();
      }
    }
    else if(o.type===OBJ.FIRE){
      const img=IMGS.fire;
      const s=o.w;
      if(img && img.complete) cx.drawImage(img, sx, sy, s, s);
      else { cx.fillStyle='#f33'; cx.fillRect(sx,sy,s,s); }
    }

    cx.restore();
  }

  // ãƒ´ã‚£ãƒ©ãƒ³
  drawVillain();

  // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼
  drawPlayer();

  // ãƒ‡ãƒãƒƒã‚°ã‚¬ã‚¤ãƒ‰ï¼ˆå¿…è¦ãªã‚‰ï¼‰
  // cx.fillStyle='rgba(255,0,0,.2)'; cx.fillRect(0, groundY, vw, 2);
}

function drawPlayer(){
  const sx = player.x;
  const sy = player.y;
  const imgBody = player.inv ? IMGS.gold : (selectedChar===CHAR.A ? IMGS.charA : IMGS.charB);
  const w = player.w, h = player.h;

  // èµ°è¡Œã«åˆã‚ã›ã¦è¶³ä¸‹ã«â€œå½±â€ã‚’æã„ã¦æµ®ãå¯¾ç­–ï¼ˆåœ°é¢ã¨ãƒ¬ãƒ³ã‚¬ã«è¦–è¦šçš„æ¥ç¶šï¼‰
  cx.save();
  cx.fillStyle='rgba(0,0,0,.35)';
  const shW = Math.floor(w*0.9), shH = 10;
  cx.beginPath();
  cx.ellipse(sx + w*0.5, groundY + 6, shW*0.5, shH, 0, 0, Math.PI*2);
  cx.fill();
  cx.restore();

  // æœ¬ä½“
  cx.save(); cx.imageSmoothingEnabled=false;
  if(imgBody && imgBody.complete) cx.drawImage(imgBody, sx, sy, w, h);
  else { cx.fillStyle='#ccc'; cx.fillRect(sx,sy,w,h); }

  // ç„¡æ•µä¸­ã‚­ãƒ©ã‚­ãƒ©
  if(player.inv){
    const t = (now_ms()/160)|0;
    const star = (t%2) ? IMGS.star1 : IMGS.star2;
    if(star && star.complete){
      for(let i=0;i<3;i++){
        const rx = sx + randi(4,w-20);
        const ry = sy + randi(4,h-20);
        cx.drawImage(star, rx, ry, 18, 18);
      }
    }
  }
  cx.restore();
}

/* =========================================================
   HUD æ›´æ–°
========================================================= */
const uiDist = document.getElementById('uiDist');
const uiSpeed = document.getElementById('uiSpeed');
const uiJump = document.getElementById('uiJump');
const uiCoin = document.getElementById('uiCoin');
const uiBoost = document.getElementById('uiBoost');

function updateHUD(){
  uiDist.textContent = `${meters} m`;
  uiSpeed.textContent = `${kmh} km/h`;
  uiJump.textContent = `${player.jumpsLeft}/${player.maxJumps}`;
  uiCoin.textContent = `${player.coins}`;
  uiBoost.style.width = `${Math.round(player.boost)}%`;
  // ãƒ–ãƒ¼ã‚¹ãƒˆãƒœã‚¿ãƒ³æœ‰åŠ¹åˆ¤å®š
  const can = (player.boost>0) || (now_ms() < player.enUntil);
  document.getElementById('btnBoost').disabled = !can;
}

/* =========================================================
   ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼
========================================================= */
function gameOver(){
  player.alive=false;
  state = State.OVER;
  // 2ç§’ãƒ•ã‚§ãƒ¼ãƒ‰â†’é¸æŠè‚¢
  const m = document.getElementById('modal');
  document.getElementById('modalMain').textContent = `è¨˜éŒ² ${meters} mï¼`;
  setTimeout(()=>{ m.hidden=false; }, 800);
}

/* =========================================================
   ãƒ¡ã‚¤ãƒ³ãƒ«ãƒ¼ãƒ—
========================================================= */
function loop(ts){
  if(!lastT) lastT=ts;
  const dt = Math.min(0.032, (ts-lastT)/1000);
  lastT = ts;

  if(state===State.RUN){
    update(dt);
    draw();
  }else{
    // éRUNæ™‚ã‚‚èƒŒæ™¯ã ã‘æã„ã¦é™æ­¢ç”»ã«ã—ã¦ãŠã
    draw();
  }

  requestAnimationFrame(loop);
}

/* =========================================================
   å…¥åŠ›ï¼ˆã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã‚‚æœ‰åŠ¹ã«ï¼šãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—ãƒ‡ãƒãƒƒã‚°ç”¨ï¼‰
========================================================= */
addEventListener('keydown', (e)=>{
  if(e.repeat) return;
  if(e.code==='Space' || e.code==='ArrowUp') onJump();
  if(e.code==='ShiftLeft' || e.code==='KeyX') { player.boostHold=true; }
});
addEventListener('keyup', (e)=>{
  if(e.code==='ShiftLeft' || e.code==='KeyX') { player.boostHold=false; }
});

/* =========================================================
   åˆæœŸåŒ–
========================================================= */
loadImages(()=>{
  updateGroundY(); makePatterns(); draw();
  state = State.OP;
  showOP();
  requestAnimationFrame(loop);
});

/* =========================================================
   ç”»é¢ãŒå¤‰ã‚ã£ãŸæ™‚ã® ground å†è¨ˆç®—
========================================================= */
addEventListener('resize', ()=>{ updateGroundY(); });

</script>
</body>
</html>
